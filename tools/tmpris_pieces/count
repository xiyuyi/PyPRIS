function tmpris.count
{

if [ $# -eq 9 ]
then
  slurmname=$2
  mem_per_task_G=$3
  mem_per_task=$((1024*$3))
  jobN=$4
  runtime=$5
  queue=$6
  bank=$7
  sequential_batch_N=$8
  folder_depth=$9
  if [[ $(hostname) == pascal* ]]
  then
    if [[ $queue == pdebug ]]
    then
    queue='pvis'
    fi
  fi
  unfinished=0
  total_tasks=0
  finished_tasks=0
  checkN=0
  for i in $(find . -maxdepth $folder_depth -type d)
  do
      echo $checkN
      checkN=`expr $checkN + 1`
          if [ -e $i/Go.pris_ticket ]
          then
          total_tasks=`expr $total_tasks + 1`
            if [ -e $i/saved_objects/done ]
            then
              finished_tasks=`expr $finished_tasks + 1`
            else
              unfinished=`expr $unfinished + 1`
              k="task"$unfinished"_dir=\$(pwd)/\$i"
              eval $k
            fi
          fi
  done


  # find out total number of nodes
  if [[ $(hostname) == quartz* ]]
  then
    mem_per_node=128
  elif [[ $(hostname) == pascal* ]]
  then
    mem_per_node=256
  fi

  # calculate tasks per job (round up formula)
  tasks_per_job=$((($unfinished+$jobN-1)/$jobN))

  # calculate tasks per job per batch (round up formula)
  tasks_per_job_per_batch=$((($tasks_per_job+$sequential_batch_N-1)/$sequential_batch_N))
  # calculate tasks per node based on memory requirement and memory availability (round-up formula)
  tasks_per_node=$(( ($mem_per_node) / $mem_per_task_G ))
  # calculate total number of nodes needed per job
  nodes_per_job=$((($tasks_per_job_per_batch+$tasks_per_node-1)/$tasks_per_node))


  # display status of task bundle
  echo $total_tasks total tasks
  echo $finished_tasks finished tasks
  echo $unfinished tasks to continue
  echo
  echo host: $(hostname)
  echo total jobs: $jobN
  echo For each node: $tasks_per_node tasks, each task reqiure $3 G memory.
  echo For each job: $nodes_per_job nodes will be requested, and will be used to run $tasks_per_job tasks
  echo requested time: $runtime
  echo tasks per job per batch is $tasks_per_job_per_batch
  echo tasks per job is $tasks_per_job
  echo total number of batches is $sequential_batch_N


  if [[ $1 == prepslurm ]]
  then
  tag=0
  batch_count=0
  # prepare for the slurm scripts
  echo "preparing slurm scripts... "
  for i in $(seq $jobN)
    do
      echo "prep job" $i
      sed -e "s/\[NODE NUMBER\]/$nodes_per_job/g" \
              -e "s/\[QUEUE TYPE\]/$queue/g" \
              -e "s/\[RUN TIME\]/$runtime/g" \
              -e "s/\[BANK\]/$bank/g"\
              -e "s/\[JOB NAME\]/$slurmname"-"$i/g" /g/g92/yi10/PyPRIS/tools/slurmhead > $slurmname"-"$i.sl

      for j in $(seq $tasks_per_job)
        do
          tag=`expr $tag + 1`
          batch_count=`expr $batch_count + 1`
          if [ $unfinished -ge $tag ]
            then
            k="task_dir=\$task"$tag"_dir"
            eval $k
            echo "echo submitting $task_dir/pris" >> $slurmname"-"$i.sl
            echo "  cd "$task_dir >> $slurmname"-"$i.sl
            echo "  chmod u+x pris" >> $slurmname"-"$i.sl
            echo "  srun -N1 -n1 --mem "$mem_per_task" pris &"   >> $slurmname"-"$i.sl
            echo "  " >> $slurmname"-"$i.sl
            if [ $batch_count -eq $tasks_per_job_per_batch ]
            then
              echo " wait" >> $slurmname"-"$i.sl
              echo "  " >> $slurmname"-"$i.sl
              batch_count=0
              fi
          fi
        done
        echo " wait " >>  $slurmname"-"$i.sl
        echo "echo '================ system output of the executable starts here ================'" >>  $slurmname"-"$i.sl
        echo "echo Done" >>  $slurmname"-"$i.sl
        echo "echo finish time " >>  $slurmname"-"$i.sl
        echo "date" >>  $slurmname"-"$i.sl
    done
  fi

else
  echo "options for input argument:"
  echo "    count: count the pack of tasks"
  echo "    prepslurm: to prepare a slurm script to submit all jobs"
  echo "usage:"
  echo " To count jobs:"
  echo "    tmpris.count count <slurm-script-name> <mem-per-task(GB)> <jobN> <run time hh:mm:ss> <queue> <bank> <sequenctial_batch_N> <folder_depth>"
  echo " To prep slurm to submit jobs:"
  echo "    tmpris.count prepslurm <slurm-script-name> <mem-per-task(GB)> <jobN> <run time hh:mm:ss> <queue> <bank> <sequenctial_batch_N> <folder_depth>"
  echo ""
  echo "Options"
  echo "<bank>:"
  echo "---- mmbp for LDRD-LW (project ended in 2020)"
  echo "---- cancer for ras"
  echo "---- dynimag for LDRD-ER"
  echo ""
  echo "<queue>:"
  echo "---- pbatch for calculation"
  echo "---- pdebug for debug"
  echo ""
  echo "<sequenctial_batch_N>:"
  echo "----  sequential batch number. It is sequential from batch to batch. tasks within the same batch are parallel"
fi


}
